# 9 视觉格式化模型
## 9.1 介绍
本章以及下一章描述可视化格式模型：对于视觉媒体，用户代理如何处理文档树。

在视觉格式化模型中，根据盒模型，文档树的每个元素生成0个或多个盒。这些盒的布局按照：
- 盒尺寸和类型。
- 定位方案（常规流，浮动，和绝对定位）。
- 文档树中元素之间的关系。
- 外部信息（例如，视口大小，图片的固有尺寸，等等）。

本章以及下一章定义的属性应用于连续媒体和页面媒体。然而，应用于页面媒体时，`margin`属性的含义会改动。

视觉格式化模型没有解释格式化的所有方面（例如，它没有解释`letter-spacing`的算法）。
### 9.1.1 视口
连续媒体的用户代理通常提供一个视口（屏幕上的一个窗口或者其他可见区域）给用户以查阅文档。当视口调整大小时，用户代理可能会改变文档的布局。

当视口比用来渲染文档的画布的区域更小时，用户代理应当提供滚动机制。每个画布最多有一个视口，但是用户代理可能会渲染多个画布（即，同一个文档提供不同的视图）。
### 9.1.2 包含块
在CSS 2.2中，许多盒的位置和大小根据一个被称为包含块的矩形盒的边缘来计算。通常，生成的盒作为后代盒的包含块；我们称之为一个盒为它的后代创建了包含块。短语“一个盒的包含块”指“该盒所在的包含块”，而非它生成的。

每个盒根据其包含块得到一个位置，但它不受该包含块的限制，可能会溢出。

计算包含块的尺寸的细节在下一章描述。
## 9.2 控制盒生成
下面的小节描述了CSS 2.2中盒的类型。某种程度上，盒的类型影响了它在视觉格式化模型中的行为。下面描述的`display`属性用来指定一个盒的类型。

`display`属性的某些值导致源文档的元素生成一个主盒用来包含后代盒和生成的内容并且参与到任何定位方案。一些元素除了生成主要盒还生成额外的盒：`list-item`元素。这些额外的盒根据主盒来放置。
### 9.2.1 块级元素和块盒
块级元素——源文档中形象的格式化为块的那些元素（例如，段落）——是指生成块级主盒的元素。使元素为块级的`display`属性的值包括：`block`，`list-item`，和`table`。块级盒是参与块格式化上下文的盒。

在CSS 2.2中，块级盒也是块容器盒 unless it is a table box or the principal box of a replaced element。块容器盒要么只包含块级盒要么创建内联格式化上下文并因此只包含内联级盒。主盒是块容器盒的元素是块容器元素。使非替换元素生成块容器的`display`属性的值包括`block`，`list-item`和`inline-block`。不是所有的块容器盒都是块级盒：non-replaced inline blocks and non-replaced table cells are block containers but are not block-level。既是块级盒也是块容器盒即是块盒。

三个术语“块级盒”，“块容器盒”，和“块盒”在无歧义的情况下简称为“块”。
#### 9.2.1.1 匿名块盒
[...]

换句话说：如果块容器盒包含了块级盒，那么它就只能包含块级盒。

当内联盒包含流内块级盒，该内联盒（以及相同行盒内它的内联祖先）被折断在块级盒（以及任何紧挨着的或者仅被可折叠的空白和/或流外元素隔开的块级兄弟）四周，分割为两个盒（即使某一边为空），块级盒每边一个。断点之前和之后的行盒被封闭在匿名块盒中，且块级盒变成这些匿名块盒的兄弟。当这样的内联盒被相对定位影响时，所产生的任何转变也会影响该内联盒中的块级盒。

[...]

匿名盒的属性继承自封闭的非匿名盒。非继承属性则使用初始值。

使得匿名块盒生成的元素的属性集仍然应用该元素的盒和内容。

当求解百分比值时匿名块盒会被忽略，并参考：最靠近的非匿名祖先盒。例如，`div`中匿名块盒的孩子需要知道其包含块的高度以得到一个百分比高度，那么它会使用`div`形成的包含块的高度，而不是匿名块盒的。
### 9.2.2 内联级元素盒内联盒
内联级元素是那些内容没有形成新块的源文档的元素；内容分布在数行中（例如，段落中的强调文本片段，内联图片，等等）。下列`display`属性的值使得元素内联级：`inline`，`inline-table `，`inline-block`。内联级元素生成内联级盒，参与到内联格式化上下文。

内联盒是内联级的同时内容参与到其包含的内联格式化上下文。`display`值为`inline`的非替换元素生成内联盒。不是内联盒（如可替换内联级元素，`inline-block`元素，和`inline-table`元素）的内联级盒称为原子内联级盒，因其以单一不透明盒参与到其内联格式化上下文。
#### 9.2.2.1 匿名内联盒
直接被包含在块容器元素（不在内联元素内部）的任何文本必须作为匿名内联元素。

[...]

根据`white-space`属性随后被折叠的空白内容不会生成任何匿名内联盒。

如果上下文中匿名盒的类型是清楚的，匿名内联盒盒匿名块盒都能被简单的成为匿名盒。

当格式化表格时会出现更多的匿名盒类型。
### 9.2.3 Run-in boxes
### 9.2.4 `display`属性
这个属性的值有如下含义：

`block`
这个值使得元素生成主块盒。
`inline-block`
这个值使得元素生成主内联级块容器。（`inline-block`内部被格式化为块盒，而其自身被格式化为原子内联级盒。）
`inline`
这个值使得元素生成一个或多个内联盒。
`list-item`
这个值使得元素（例如，`HTML`的`li`）生成主块盒和标记盒。
`none`
这个值使得元素不出现在格式化结构中（即，在视觉媒体中该元素不生成盒且不影响布局）。后代元素也不生成任何盒；该元素即其内容被格式化结构完全移除。给后代设置`diplay`属性不能覆盖这个行为。

请注意`display`为`none`（的元素）不会创建无形的盒；它根本不会创建盒。CSS具有机制使得元素能够在格式化结构中生成盒并影响格式化但自身不可见。
## 9.3 定位方案
在CSS 2.2中，盒可能被摆放根据三种定位方案：

1. 常规流。在CSS 2.2中，常规流包括块级盒的块格式化，内联级盒的内联格式化，和块级内联级盒的相对定位。
2. 浮动。在浮动模型中，盒首先根据常规流摆放，然后从流中取出并尽可能的向左或右移动。内容可能沿着浮动的边流动。
3. 绝对定位。在绝对定位模型中，盒从常规流中完全移除并根据包含块分配位置。

元素被称为流外的如果它使浮动的，绝对定位的，或者是根元素。元素被称为流内的如果它不是流外的。元素A的流是由A和最近的流外祖先是A的所有流内元素组成的集合。
### 9.3.1 选择定位方案：`position`属性
`position`和`float`属性确定CSS 2.2使用哪种定位算法来计算盒的位置。

这个属性的值有如下含义：

`static`
盒是常规盒，根据常规流摆放。`top`，`right`，`bottom`，和`left`属性不被应用。
`relative`
盒的位置根据常规流计算（称为常规流中的位置）。然后盒相对常规位置偏移。当盒B相对定位，其后的盒的位置被计算好像B没有偏移。The effect of 'position:relative' on table-row-group, table-header-group, table-footer-group, table-row, table-column-group, table-column, table-cell, and table-caption elements is undefined.
`absolute`
盒的位置（以及可能的大小）由`top`，`right`，`bottom`，和`left`属性指定。这些属性指定偏移根据盒的包含块。绝对定位的盒从常规流取出。这意味着其不会影响之后的兄弟的布局。同样，尽管绝对定位的盒有外边距，其不会和任何其他外边距合并。
`fixed`
盒的位置的计算如同`absolute`模型，但是另外，盒根据一些参照被固定。正如`absolute`模型一样，盒的外边距不会和任何其他外边距合并。在手持，投影，屏幕，电传打印机，和电视媒体此类情况下，盒根据视口固定且不会在滚动时移动。在打印媒体此类情况下，盒被渲染到每个页面，并且根据页面盒固定，尽管页面通过视口查看（例如，在打印预览的情况下）。对于其他媒体类型，展示未被定义。作者可能希望以媒体依赖的方式指定`fixed`。例如，作者可能需要在屏幕上盒保持在视口的顶部，但不在每页打印页面的顶部。这两条要求可以被`@media`规则分离。

用户代理可能将根元素的位置视为`static`。
### 9.3.2 盒偏移：`top`，`right`，`bottom`，`left`
元素的`position`属性具有除`static`的值时被称为定位的。定位的元素生成定位的盒，根据四个属性摆放：
`top`
这个属性指定绝对定位的盒的上外边缘在包含块的上边缘下面偏移多远。对于相对定位的盒，偏移是根据自身的上边缘（即，在常规流中盒的位置，再根据这些属性从此位置偏移）。
`right`
如同`top`，但是指定盒的右外边缘在包含块的右边缘的左面偏移多远。对于相对定位的盒，偏移是根据自身的右边缘。
`bottom`
如同`top`，但是指定盒的下外边缘在包含块的下边缘的上面偏移多远。对于相对定位的盒，偏移是根据自身的下边缘。
`left`
如同`left`，但是指定盒的左外边缘在包含块的左边缘的右面偏移多远。对于相对定位的盒，偏移是根据自身的左边缘。

这四个属性的值有如下含义：

`<length>`
距离参照边缘的偏移是固定的。允许负值。
`<percentage>`
偏移是包含块的宽（对于`left`或`right`）或高（对于`top`或`bottom`）的百分比。允许负值。
`auto`
对于非替换元素，这个值的作用依赖值也为`auto`的相关属性。对于可替换元素，这个值的作用仅依赖可替换内容的固有尺寸。
## 9.4 常规流
常规流的盒属于格式化上下文，在CSS 2.2中可能是表格，块或内联。在CSS的未来等级中，其他格式化上下文类型会被引入。块级盒参与到块格式化上下文。内联级盒参与到内联级格式化上下文。表格格式化上下文在后文中描述。
### 9.4.1 块格式化上下文
浮动，绝对定位元素，不是块盒的块容器（如`inline-block`，`table-cell`，和`table-caption`），和`overflow`不为`visible`的块盒（except when that value has been propagated to the viewport）创建新的块格式化上下文给它们的内容。

在块格式化上下文中，盒被一个挨一个，垂直地，从包含块的顶部开始摆放。两个盒之间的垂直距离由`margin`属性确定。块格式化上下文中相邻块级盒之间的垂直外边距会合并。

在块格式化上下文中，每个盒的左外边缘挨着包含块的左边缘（对于由右至左的格式化，右边缘挨着）。存在浮动时依然如此（尽管由于浮动，盒的行盒可能缩小），除非盒创建了新的块格式化上下文（这种情况下由于浮动，盒自身可能变得更窄）。
### 9.4.2 内联格式化上下文
内联格式化上下文由不包含块级盒的块容器创建。在内联格式化上下文中，盒被水平地，一个挨着一个，从包含块的顶部开始摆放。这些盒之间的水平外边距，边框，盒内边距都被遵守。盒可能以不同的方式垂直对齐：其顶部或底部可能被对齐，或者其内部的文本的基线可能被对齐。包含一行的盒的矩形区域称为行盒。

行盒的宽度由包含块盒存在的浮动确定。The height of a line box is determined by the rules given in the section on line height calculations.

行盒总是足够的高以满足包含的所有盒。然而，它可能比所包含的最高的盒还高（例如，盒被对齐以使基线排成一行）。当盒B的高度小于包含它的行盒的高度，B在行盒中的垂直对齐由`vertical-align`属性确定。当几个内联级盒不能水平地适配在一个单独的行盒中，它们分布在两个或更多垂直堆叠的行盒中。因此，段落是行盒的垂直堆叠。行盒堆叠在垂直方向没有间隔（除了别处的指定）且不会重叠。

通常，行盒的左边缘挨着包含块的左边缘且右边缘挨着包含块的右边缘。然而，浮动盒可能出现在包含块边缘和行盒边缘之间。因此，尽管同一个内联格式化上下问中行盒通常有相同的宽度（也即包含块的宽度），它们可能在宽度上改变如果由于浮动可用的水平空间被减少。同一个内联格式化上下文中行盒的高度通常会改变（例如，某行可能包含一个高图片而其他行仅包含文本）。

当一行的所有内联级盒的总宽度小于包含它们的行盒的宽度时，它们在行盒中的水平分布由`text-align`属性确定。如果该属性的值为`justify`，用户代理也可能拉伸内联盒的空格盒单词。

当内联盒超过行盒的宽度，它被分割到几个盒中并且这些盒被分布在几个行盒中。如果内联盒不能被分割（例如，如果内联盒包含单个字符，或语言特性单词断开规则不允许断开在该内联盒中，或如果内联盒被值为`nowrap`或`pre`的`white-space`影响），那么内联盒溢出该行盒。

当内联盒被分割，外边距，边框，盒内边距在分割处没有视觉上的效果（或者在任何分割处，当有几个时）。

内联盒也可能由于双向文本处理被分割到同一个行盒的几个盒中。

行盒根据持有内联格式化上下文的内联级内容的需要来创建。不含[...]的行盒必须作为零高的行盒以确定其内部的元素的位置，而非其他目的。
### 9.4.3 相对定位
一旦盒已经被摆放根据常规流或浮动，它可能被转移相对那个位置。这被称为相对定位。以这种方式偏移盒（B1）不会影响盒（B2）：B2获得的位置好像B2没有偏移过且B2不会重新定位在B1应用偏移后。这意味着相对定位可能导致盒重叠。无论如何，如果相对定位导致`overflow:auto`或`overflow:scroll`的盒溢出的话，用户代理必须允许访问此内容（在它偏移的位置），通过滚动条的创建，可能影响布局。

相对定位的盒维持着它的常规流大小，包括行中断和最初给它预留的空间。

对于相对定位的元素，`left`和`right`水平地移动盒，不改变其大小。`left`向右移动盒，且`right`向左移动盒。因为盒不会被分割或缩小作为`left`或`right`的结果，应用值总是：left = -right。

如果`left`和`right`都是`auto`（它们的初始值），应用值为`0`（即，盒呆在初始位置）。

如果`left`是`auto`，它的应用值是`right`的值的负数（即，盒根据`right`的值向左移动）。

如果`right`被指定为`auto`，它的应用值是`left`的值的负数。

如果`left`和`right`都不是`auto`，位置被过度强迫，且两者中忽略一个。如果包含块的`direction`属性是`ltr`，`left`的值获胜且`right`变成-`left`。如果包含块的`direction`是`rtl`，`right`获胜且`left`被忽略。

`top`和`bottom`属性移动相对定位元素向上或向下且不改变其大小。`top`向下移动盒，且`bottom`向上移动之。因为盒不会被分割或缩小作为`top`或`bottom`的结果，应用值总是：top = -bottom。如果都是`auto`，它们的应用值为`0`。如果两者有一个是`auto`，则它变成另一个的负数。如果都不是`auto`，`bottom`被忽略（即，`bottom`的应用值会是`top`的值的负数）。

## 9.5 浮动
浮动是指在当前行移动到左边或右边的盒。浮动最有趣的特征是内容会沿着它的边流动（或者通过`clear`属性禁止此行为）。内容左浮动盒的右边流下盒右浮动盒的左边流下。下面介绍浮动定位盒内容流；管理浮动行为的精确规则由`float`属性描述。

浮动盒被转移到左边或右边直到它的外边缘挨着包含块的边缘或者其他浮动的外边缘。如果有行盒，浮动盒的上外边和该行盒的顶部对齐。

对于浮动如果没有足够的水平空间，它向下转移直到要么它适配了要么不再出现浮动。

因为浮动不在流内，在浮动盒之前之后创建的非定位块盒垂直地流动好像浮动不存在一样。然而，接着浮动的当前和随后创建的行盒由于给浮动的外边盒留出空间的需要被缩短了。

行盒接着浮动仅当存在一个垂直的位置满足全部四种情况：（a）在行盒的顶部或之下，（b）在行盒的底部或之上，（c）在浮动的上外边缘的下方，和（d）在浮动的下外边缘的上方。

注意：这意味着零外高或者负外高的浮动不会缩短行盒。

如果缩短的行盒太小不能包含任何内容，那么它会向下转移（其宽度重新计算）直到要么一些内容适配了要么不再出现浮动。在浮动盒之前的同行中的任何内容重流到该行浮动的另一边。换句话说，如果摆放在行上的内联级盒在遇到适配了剩余的行盒空间的左浮动之前，左浮动摆放在那个行里，和行盒的顶部对齐，于是已在该行的内联级盒相应地移动到浮动的右边（右边即是左浮动的另一边）且反之亦然对于右浮动。

表格的边框盒，块级可替换元素，或者常规流中创建新的块格式化上下文的元素（如`overflow`值不是`visible`的元素）不允许和与该元素同一块格式化上下文中的任何浮动的外边盒重叠。如果必需，实现应当清除该元素通过把它摆放到任何上述浮动的下方，但是如果有足够的空间可以把它挨着这些浮动摆放。

[...]

因为章节8.3.1的规定，浮动盒的外边距不会与相邻盒的外边距合并。因此，在上一个例子中，`p`盒和浮动的`img`盒之间的垂直外边距没有合并。

浮动的内容都是堆叠的好像浮动生成了新的堆叠上下文，除了任何定位元素和确实创建新的堆叠上下文并参与到浮动的父堆叠上下文的元素。浮动可以和常规流中的其他盒重叠（例如，当常规流盒接着有负数外边距的浮动）。当这事发生时，浮动被渲染到非定位流内块的前方，但是在流内内联的后方。

[...]
### 9.5.1 定位浮动：`float`属性
这个属性指定盒是否应该浮动到左边，右边，或者都不是。它可以设置在任何元素上，但是只能应用在生成的盒不是绝对定位的元素。这个属性的值有如下含义：

`left`
元素生成浮动到左边的块盒。内容在盒的右边流动，从顶部开始。
`right`
与`left`一样，除了盒浮动到右边，且内容在盒的左边流动，从顶部开始。
`none`
盒不浮动。

用户代理可以对待根元素的浮动如同`none`。

这里是管理浮动的行为的严格规则：

1. 左浮动的左外边缘不可以在包含块的左边缘的左边。对于右浮动元素亦然。
2. 如果当前盒是左浮动的，且源文档中之前的元素有生成任何左浮动盒，那么对于每一个这样之前的盒，要么当前盒左外边缘必须在之前的盒的右外边缘的右边，要么其顶部必须比之前的盒的底部要低。对于右浮动盒依然。
3. 左浮动盒的右外边缘不可以在任何接着的右浮动盒左外边缘的右边。对于右浮动元素亦然。
4. 浮动盒的上外边不可以比包含块的顶部高。当浮动发生在两个合并的外边距之间时，浮动被定为好像它有另外的匿名块父亲参与到流中。这样的父亲的位置通过外边距合并章节中的规则定义。
5. 浮动盒的上外边不可以高于源文档中之前的元素生成的块盒或浮动盒的上外边。
6. 元素的浮动盒的上外边不可以高于任何包含源文档中之前的元素生成的盒的行盒的顶部。
7. 左边有左浮动盒的左浮动盒的右外边缘不可以在包含块的右边缘的右边。（简言之：左浮动不可以从右边缘伸出，除非它已经尽可能向左。）对于右浮动亦然。
8. 浮动盒必须尽可能高的摆放。
9. 左浮动盒必须尽可能向左，右浮动盒尽可能向右。更高的位置优先于更左/右。

但是在CSS 2.2中，在块格式化上下文中，垂直负边距的浮动位置没有定义。

这些规则里引用的其他元素仅指和浮动在同一块格式化上下文中的其他元素。
### 9.5.2 控制接着浮动的流：`clear`属性
这个属性指示了元素的盒的哪一边不可以和之前的浮动盒相邻。`clear`属性不考虑其内部的或其他块格式化上下文内部的浮动。

当值应用在非浮动块级盒时有如下含义：

`left`
要求盒的上边框边缘在源文档中之前的元素生成的任何左浮动盒的下外边缘的下方。
`right`
要求盒的上边框边缘在源文档中之前的元素生成的任何右浮动盒的下外边缘的下方。
`both`
要求盒的上边框边缘在源文档中之前的元素生成的任何右浮动和左浮动盒的下外边缘的下方。
`none`
不约束盒的位置根据浮动。

非`none`值可能会引入间隙。间隙阻止外边距合并且作为元素的上外边距上方的间隔。它被用来把元素垂直地推过浮动。

计算设置了`clear`的元素的间隙首先要考虑元素的上边框边缘的假设的位置。这个位置是如果元素的`clear`属性为`none`时上边框边缘的实际位置。

如果元素的上边框边缘的假设的位置不在相关的浮动之后，那么间隙被引入，且外边距合并根据8.3.1的规则。

间隙的高度被设置为更大的那个：

1. 摆放的块的边框边缘与被清除的最低的浮动的下外边缘对齐时需要的高度。
2. 摆放的块的上边框边缘在假设的位置时需要的高度。

二者取其一，间隙被精确地设置为摆放的块的边框边缘与被清除的最低的浮动的下外边缘对齐时需要的高度。

间隙可能是负数或零。

[...]

当浮动元素设置此属性时，对于定位该浮动导致规则的修改。额外的约束（第10条）被添加：
- 浮动的上外边缘必须低于所有之前的左浮动盒（在`clear: left`的情况下），或所有之前的右浮动盒（在`clear: right`的情况下），或皆是（`clear: both`）的下外边缘。

CSS 1中这个属性应用到所有的元素。实现可能因此使这个属性支持到所有元素上。在CSS 2和CSS 2.2中`clear`属性仅应用到块级元素。所有作者应该只在块级元素上使用这个属性。如果实现支持了内联元素的清除，却没有设置上面解释的间隙，实现应该强制打断并插入一个或多个空的行盒使被清除的内联的行盒顶部移动到相应浮动盒的底部。
## 9.6 绝对定位

在绝对定位模型中，盒根据包含块明确地偏移。它被完全地从常规流中移除（它不会影响后面地兄弟）。绝对定位盒给常规流盒绝对（非固定）定位的后代创建新的包含块。然而，绝对定位的元素的内容不会绕着其他盒流动。它们可能掩盖其他盒的内容（或者被掩盖），依赖于重叠盒的堆叠等级。

规范中引用的绝对定位元素（或其盒）意味着该元素的`position`属性的值为`absolute`或`fixed`。
### 9.6.1 固定定位
固定定位使绝对定位的亚类。对于固定定位唯一的区别是包含块由视口创建。对于连续媒体，当滚动文档时固定盒不会移动。在这方面，更像是固定的背景图片。对于页面媒体，固定盒在每页重复。这很有用对于摆放，比如，每页底部的签名。固定定位的盒超出页面区域的部分会被剪除。固定盒在初始包含块不可见的部分不会打印。
## 9.7 `display`，`position`，和`float`之间的关系
影响盒生成和布局的三个属性——`display`，`position`，和`float`——相互影响如下：

1. 如果`dispaly`值为`none`，那么`position`和`float`不会应用。此时，元素不会生成盒。
2. 否则，如果`position`值为`absolute`或`fixed`，盒是绝对定位的，`float`的计算值为`none`，且`display`根据下表设置。盒的位置由`top`，`right`，`bottom`和`left`属性和盒的包含块确定。
3. 否则，如果`float`值为非`none`的，盒是浮动的且`display`根据下表设置。
4. 否则，如果元素是根元素，`display`根据下表设置，除了CSS 2.2中未定义的指定值为`list-item`是否变为计算值`block`或`list-item`。
5. 否则，剩余的`display`属性的值应用指定值。
## 9.8 常规流，浮动，盒绝对定位的比较
[...]
## 9.9 分层展示
### 9.9.1 指定堆叠等级：`z-index`属性
对于定位盒，`z-index`属性指明：
1. 当前堆叠上下文中盒的堆叠等级。
2. 盒是否创建堆叠上下文。

值有如下含义：

`<integer>`
此数值是当前堆叠上下文中生成的盒的堆叠等级。盒创建新的堆叠上下文。
`auto`
当前堆叠上下文中生成的盒的堆叠等级是`0`。如果盒有`position: fixed`或是根元素的盒，则也创建新的堆叠上下文。

在CSS 2.2中，每个盒在三个维度各有一个位置。除了它们的水平和垂直位置，盒沿着Z-轴摆放且被格式化为一个在另一个的上方。当盒在视觉上重叠时特别与Z-轴的位置相关。此章节讨论盒如何沿着Z-轴定位。

被画在画布上的渲染树的顺序由术语堆叠上下文描述。堆叠上下文可以包含更进一步的堆叠上下文。某个堆叠上下文以父堆叠上下文的角度看时原子的；其他堆叠上下文的盒不可以出现在该上下文的任何盒之间。

每个盒属于某一个堆叠上下文。给出的堆叠上下文中的每个定位盒有个数值堆叠等级，是在Z-轴上相对于同一个堆叠上下文中其他堆叠等级的位置。更大的堆叠等级的盒总是被格式化在更低的堆叠等级的盒的上方。盒可能有负的堆叠等级。堆叠上下文中相同堆叠等级的盒根据文档树顺序由后至前堆叠。

根元素形成根堆叠上下文。其他堆叠上下文由任何定位元素（包括相对定位元素）`z-index`的计算值不为`auto`生成。堆叠上下文不一定盒包含块有关。

每个堆叠上下文中，下面的图层由后至前被画：

1. 形成堆叠上下文的元素的背景和边框。
2. 堆叠等级为负的子堆叠上下文（最负的开始）。
3. 流内，非内联级，非定位后代。
4. 非定位浮动。
5. 流内，内联级，非定位后代，包括内联表格和内联块。
6. 堆叠等级为0的子堆叠上下文和堆叠等级为0的等位后代。
7. 堆叠等级为正的子堆叠上下文（最小的开始）。

每个堆叠上下文中，堆叠等级为0（在层6）的定位元素，非定位浮动（层4），内联块（层5），和内联表格（层5），被画好像这些元素自身生成了新的堆叠上下文，除了它们的定位后代和任何将成为子堆叠上下文并参与到当前堆叠上下文。

画的顺序递归地应用到每个堆叠上下文。